# vega_test_task
Порядок выполнения тестового задания
Необходимые библиотеки:

python3-mapscript

Опционально python3-sqlalchemy

Опционально «любимый» лёгкий web-фреймворк: flask, bottle, aiohttp и т.д.

Вводные данные
В каталоге src есть следующие файлы:

mapfile_web.py — минималистичный web-сервер для рендеринга картостиля на python3-mapscript и wsgiref

spb3857.json — данные для рендеринга карты в системе координат pseudo-mercator (EPSG:3857)

spb3857.map — картостиль для рендеринга в системе координат pseudo-mercator (EPSG:3857)

spb4326.json — данные для рендеринга карты в системе координат WGS84 (EPSG:4326)

spb4326.map — картостиль для рендеринга в системе координат WGS84 (EPSG:4326)

Каждую пару "картостиль + данные" можно запустить командами:

bash
python3 mapfile_web.py spb3857.map
python3 mapfile_web.py spb4326.map
Результатом в обоих случаях будет запуск web-сервера на порту 3007.

Если на той же рабочей станции в браузере выполнить запрос:
http://localhost:3007/?SERVICE=WMS&VERSION=1.3.0&REQUEST=GetMap&BBOX=3359332.801464934368,8381615.12248637341,3377232.975584486965,8395864.989966142923&CRS=EPSG:3857&WIDTH=1016&HEIGHT=808&LAYERS=spb&STYLES=&FORMAT=image/png

То будет получен результат в виде изображения:
![Alt text](https://raw.githubusercontent.com/KonstantinLjapin/vega_test_task/main/exmpl_map.jpg)

Это результат рендеринга картостиля — запрос одинаков в обоих случаях и даёт одинаковый результат.

Задача
Создать систему загрузки пары картостиль.map + данные_для_рендеринга.json в таблицу SQLite DB со следующим набором полей:

id (int) — id записи в БД

mapname (str) — имя, по которому будет срабатывать запрос из раздела 2

mapstyle (str) — поле для хранения данных файла «картостиль.map»

gjson (str) — поле для хранения данных файла «данные_для_рендеринга.json»

Для этой задачи можно использовать как чистый python sqlite3, так и ORM-фреймворк sqlalchemy.

Модифицировать или полностью переписать на «любимом web-фреймворке» логику работы mapfile_web.py так, чтобы при запросе вида:
http://localhost:3007/<mapname>?<wms запрос из базового примера>:

Из БД по mapname из поля gjson выгружался файл «данные_для_рендеринга.json» во временное хранилище (произвольный каталог) [1].

Модифицированный web-сервер получал из БД по mapname данные файла «картостиль.map» и передавал их на обработку python-mapscript (как это сделано в базовом примере, см. PubMapWEB.application) [2].

Проверка работы производится запросом вида:
http://localhost:3007/<mapname>?SERVICE=WMS&VERSION=1.3.0&REQUEST=GetMap&BBOX=3359332.801464934368,8381615.12248637341,3377232.975584486965,8395864.989966142923&CRS=EPSG:3857&WIDTH=1016&HEIGHT=808&LAYERS=spb&STYLES=&FORMAT=image/png
в обоих случаях дающего результат как в базовом примере.

Примечания к задаче:
Система загрузки может представлять из себя:

консольную утилиту,

GUI, TUI и прочие UI-приложения,

систему загрузки данных на web-сервер по POST-запросу (в этом случае систему загрузки можно совместить с web-сервисом рендеринга),

и т.д.

** [1] Необходимо, чтобы картостиль «увидел» выгруженный файл «данные_для_рендеринга.json» в произвольном каталоге. Для этого в файле «картостиль.map» следует заранее, до его загрузки в БД, изменить строку 27:
CONNECTION "данные_для_рендеринга.json",
дописав к имени файла путь к каталогу выгрузки. В результате строка CONNECTION должна выглядеть так:
"/путь/выгрузки/данные_для_рендеринга.json".
Выгружаемый из БД файл «данные_для_рендеринга.json» должен иметь то же имя, что указано в CONNECTION «картостиль.map». Для этого можно хранить имя файла (без расширения) в поле БД mapname.

*** [2] Допускается как модификация базового примера mapfile_web.py, так и полное переписывание логики на выбранный web-фреймворк. Во втором случае следует учесть, что логику из PubMapWEB.application (#mapserver magic) лучше оставить без изменений (если нет опыта работы с mapserver). Исключением является строка 25:
request.loadParamsFromURL(env['QUERY_STRING']),
где вместо env['QUERY_STRING'] следует передавать request query string вашего web-фреймворка.

Результаты
Результатом выполнения работы является создание кода, выполняющего описанный в задаче функционал.

Предоставление результатов тестового задания следует организовать в виде проекта на https://github.com или https://gitlab.com — это позволит обсуждать выполнение задания в рамках ваших проектов. Имя пользователя специалиста от предприятия: oldbay (в обоих случаях).


## Установка библиотек в отсутсвии виртуального окружения
- использовался системный python3.10 
- pip3 install "fastapi[standard]"
- pip3 install --pre SQLAlchemy
- mapscript устанавливается используя документацию 


### Запуск и проверка
- python3 main.py
- http://0.0.0.0:3007/docs есть готовый GUI вэб интерфейс (Swagger Open API) можно использовать для тестов
#### c помощью curl
- curl -v -X POST "http://localhost:3007/upload"   -F "map_file=@upload_file/demo_spb4326.map"   -F "json_file=@upload_file/demo_spb4326.json" # для загрузки в бд через POST запрос 
- curl "http://localhost:3007/spb3857?SERVICE=WMS&VERSION=1.3.0&REQUEST=GetMap&BBOX=3359332.801464934368,8381615.12248637341,3377232.975584486965,8395864.989966142923&CRS=EPSG:3857&WIDTH=1016&HEIGHT=808&LAYERS=spb&STYLES=&FORMAT=image/png" -o output.png # загрузит сгенерированый файл
#### или в браузере
- http://localhost:3007/spb3857?SERVICE=WMS&VERSION=1.3.0&REQUEST=GetMap&BBOX=3359332.801464934368,8381615.12248637341,3377232.975584486965,8395864.989966142923&CRS=EPSG:3857&WIDTH=1016&HEIGHT=808&LAYERS=spb&STYLES=&FORMAT=image/png # загрузит сгенерированый файл
